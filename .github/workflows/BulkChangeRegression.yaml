name: Bulk Change Regression Tests
on: 
  workflow_dispatch:
    inputs:
      environment:
        description: 'Select Environment to run'
        required: true
        default: 'pit'
        type: choice
        options:
          - pit
          - stage

      report-integration:
          description: 'Select Testmo Project'
          required: true
          default: 'Test Project'
          type: choice
          options:
            - Test Project
            - Mode QA      
#   schedule:
    #- cron: '0 5 * * *'  # 10:30 AM IST (UTC+5:30) = 5:00 AM UTC -> 1:00 AM EST 
    # - cron: '30 8 * * *'  # 2:00 PM IST (UTC+5:30) = 8:30 AM UTC -> 4:30 AM EST
  # push:
  #   branches:
  #     - master
jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          ref: master
      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: lts/*
      - name: Install dependencies
        run: npm install
      - name: Install Playwright browsers
        run: npx playwright install chrome --with-deps
      - name: Run Playwright tests
        run: npx playwright test --grep "@at_bulkchange_run"
        
        env:
          TEST_MODULE: BULKCHANGE
          RUN_NAME: BULKCHANGE
          POSTMARK_API_KEY: ${{ secrets.POSTMARK_API_KEY }}
          SVC_USER: ${{ secrets.SVC_USER }}
          TESTMO_TOKEN: ${{ secrets.TESTMO_TOKEN }}
          source: ${{ (github.event_name == 'schedule' && 'Scheduled') || (github.event_name == 'workflow_dispatch' && 'Manual') || 'Local' }}
          EXECUTION_ENV: ${{ github.event_name == 'schedule' && 'pit' || github.event.inputs.environment }}
          REPORT_INTEGRATION: ${{ github.event_name == 'schedule' && 'Mode QA' || github.event.inputs.report-integration }}
          
      - name: Upload Playwright Test Report
        uses: actions/upload-artifact@v4
        if: always()  # Upload report even if tests fail
        with:
          name: playwright-report
          path: src/reporting/playwright-report/
          retention-days: 30
